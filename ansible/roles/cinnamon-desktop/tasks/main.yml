---
# Cinnamon desktop customization for Windows-like experience (FR-7)

# Install Cinnamon desktop on Ubuntu (not included by default)
- name: Install Cinnamon desktop environment
  apt:
    name:
      - cinnamon-desktop-environment
      - cinnamon-core
      - cinnamon-applets
      - cinnamon-screensaver
      - nemo
      - nemo-fileroller
    state: present
    update_cache: yes
  tags: cinnamon-install

- name: Set Cinnamon as default session
  alternatives:
    name: x-session-manager
    path: /usr/bin/cinnamon-session
  tags: cinnamon-install

# Install themes with fallback
- name: Install theme packages
  block:
    - name: Try to install Mint-Y themes
      apt:
        name:
          - mint-themes
          - mint-y-icons
        state: present
      register: mint_theme_install
      ignore_errors: yes

    - name: Install fallback themes if Mint-Y unavailable
      apt:
        name:
          - arc-theme
          - papirus-icon-theme
        state: present
      when: mint_theme_install is failed
  tags: themes

- name: Create dconf profile directory
  file:
    path: /etc/dconf/profile
    state: directory
    mode: '0755'

- name: Create user dconf profile
  copy:
    dest: /etc/dconf/profile/user
    content: |
      user-db:user
      system-db:local
    mode: '0644'

- name: Create dconf local.d directory
  file:
    path: /etc/dconf/db/local.d
    state: directory
    mode: '0755'

- name: Deploy Cinnamon desktop settings (Windows-like configuration)
  copy:
    src: files/00-solid-desktop.conf
    dest: /etc/dconf/db/local.d/00-solid-desktop.conf
    mode: '0644'
  notify: update dconf

- name: Deploy panel configuration
  copy:
    src: files/01-solid-panel.conf
    dest: /etc/dconf/db/local.d/01-solid-panel.conf
    mode: '0644'
  notify: update dconf

- name: Deploy theme and appearance settings
  copy:
    src: files/02-solid-theme.conf
    dest: /etc/dconf/db/local.d/02-solid-theme.conf
    mode: '0644'
  notify: update dconf

- name: Copy SOLID wallpaper
  copy:
    src: files/solid-wallpaper.jpg
    dest: /usr/share/backgrounds/solid-wallpaper.jpg
    mode: '0644'
  when: lookup('fileglob', 'files/solid-wallpaper.jpg')

- name: Set fallback Ubuntu wallpaper if custom not available
  copy:
    src: /usr/share/backgrounds/warty-final-ubuntu.png
    dest: /usr/share/backgrounds/solid-wallpaper.jpg
    remote_src: yes
    mode: '0644'
  when: not lookup('fileglob', 'files/solid-wallpaper.jpg')
  ignore_errors: yes

- name: Apply settings to /etc/skel for all new users
  file:
    path: /etc/skel/.config
    state: directory
    mode: '0755'

- name: Update dconf database
  command: dconf update
  changed_when: false

handlers:
  - name: update dconf
    command: dconf update
