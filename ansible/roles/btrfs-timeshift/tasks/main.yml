---
# BTRFS and Timeshift configuration for system snapshots (FR-6.2)

- name: Ensure BTRFS tools are installed
  apt:
    name:
      - btrfs-progs
      - grub-btrfs
    state: present

- name: Configure Timeshift for BTRFS snapshots
  copy:
    dest: /etc/timeshift/timeshift.json
    content: |
      {
        "backup_device_uuid" : "",
        "parent_device_uuid" : "",
        "do_first_run" : "false",
        "btrfs_mode" : "true",
        "include_btrfs_home_for_backup" : "false",
        "include_btrfs_home_for_restore" : "false",
        "stop_cron_emails" : "true",
        "btrfs_use_qgroup" : "true",
        "schedule_monthly" : "{{ timeshift_schedule_monthly | default(1) }}",
        "schedule_weekly" : "{{ timeshift_schedule_weekly | default(3) }}",
        "schedule_daily" : "{{ timeshift_schedule_daily | default(5) }}",
        "schedule_hourly" : "{{ timeshift_schedule_hourly | default(6) }}",
        "schedule_boot" : "{{ timeshift_schedule_boot | default(3) }}",
        "count_monthly" : "{{ timeshift_schedule_monthly | default(1) }}",
        "count_weekly" : "{{ timeshift_schedule_weekly | default(3) }}",
        "count_daily" : "{{ timeshift_schedule_daily | default(5) }}",
        "count_hourly" : "{{ timeshift_schedule_hourly | default(6) }}",
        "count_boot" : "{{ timeshift_schedule_boot | default(3) }}",
        "snapshot_size" : "0",
        "snapshot_count" : "0",
        "date_format" : "%Y-%m-%d %H:%M:%S",
        "exclude" : [],
        "exclude-apps" : []
      }
    mode: '0644'
  when: timeshift_snapshot_type == "btrfs"

- name: Create Timeshift config directory if it doesn't exist
  file:
    path: /etc/timeshift
    state: directory
    mode: '0755'

- name: Enable grub-btrfs for booting from snapshots
  systemd:
    name: grub-btrfsd
    enabled: yes
  when: timeshift_snapshot_type == "btrfs"
  ignore_errors: yes  # Service may not exist yet

- name: Add informational message about Timeshift
  copy:
    dest: /etc/profile.d/timeshift-info.sh
    content: |
      #!/bin/bash
      # SOLID Linux Mint - Timeshift Information
      # Timeshift is configured for automatic BTRFS snapshots
      # Run 'sudo timeshift-gtk' to manage snapshots
    mode: '0644'
